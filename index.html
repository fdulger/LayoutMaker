<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="lib/jquery-ui-1.12.1/jquery-ui.css">
    <script src="lib/jquery-ui-1.12.1/external/jquery/jquery.js"></script>
    <script src="lib/jquery-ui-1.12.1/jquery-ui.js"></script>
    <style>
        button {
            width: 150px;
        }
    </style>
</head>
<body>
    <button type="button" disabled>New Slot</button>
    <button type="button" class="perSlot" disabled>Delete</button>
    <button type="button" class="perSlot" disabled>Move To Back</button>
    <button type="button" class="perSlot" disabled>Bring To Front</button>
    <br/>
    <button type="button" class="perSlot" disabled>Split Vertically</button>
    <button type="button" class="perSlot" disabled>Split Horizontally</button>
    <button type="button" class="perSlot" disabled>Extend Vertically</button>
    <button type="button" class="perSlot" disabled>Extend Horizontally</button>
    <button type="button" class="perSlot" onclick="exportLayout()">Export</button>
    <br/>
    <br/>

    <div id="editorArea" class="ui-widget-content" style="position:relative;width: 800px; height: 500px;">
    </div>
</body>
<script>

    let loadedLayout = undefined

    function exportLayout() {
        const layoutJson = JSON.stringify(loadedLayout, null, 4)
        const layoutBlob = new Blob([layoutJson], {type: 'application/json'})
        window.open(URL.createObjectURL(layoutBlob))
    }

    function loadLayout(layout) {
        $.ajax({
            url: 'layouts/' + layout + '.json',
            context: $("#editorArea")
        })
        .done(function (layout) {
            loadedLayout = layout
            draw(loadedLayout, this)
        })
    }

    function draw(layout, context) {
        $(context).html(
            layout.layoutTemplateSlots.map(slotJson => {
                const slot = htmlSlot(slotJson)
                return $('<div />', {
                    style: `
                        border: 5px solid black;
                        background-color: ${getRandomColor()};
                        position: absolute;
                        top: ${slot.top}%;
                        left: ${slot.left}%;
                        width: ${slot.width}%;
                        height: ${slot.height}%;
                        z-index: ${slot.zOrder}
                    `,
                    class: 'layoutSlot'
                })
                .bind('mousedown', function() {
                    $(this).css("border", "5px dotted red")
                })
                .bind('mouseup', function() {
                    $(this).css("border", "5px solid black")
                })
                .draggable(
                    {
                        disabled: false,
                        snap: "#editorArea,.layoutSlot",
                        containment: "parent",
                        stop: function(event, ui) {
                            move(slot.id, ui.position)
                        }
                    }
                ).resizable(
                    {
                        handles: "all",
                        disabled: false,
                        containment: "parent",
                        minHeight: 100,
                        minWidth: 100,
                        aspectRatio: false,
                        autoHide: true,
                        stop: function(event, ui) {
                            resize(slot.id, ui.position, ui.size)
                        }
                    }
                )
            })
        )
    }

    function getRandomColor() {
        const letters = '0123456789ABCDEF'
        let color = '#'
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)]
        }
        return color
    }

    function htmlSlot(jsonSlot) {
        return {
            id: jsonSlot.id,
            top: jsonSlot.y * 100,
            left: jsonSlot.x * 100,
            width: jsonSlot.width * 100,
            height: jsonSlot.height * 100,
            zOrder: jsonSlot.zOrder,
        }
    }

    function toRelative(x, y) {
        return {
            x: Math.round(Math.max(x / 800, 0) * 1e2) / 1e2,
            y: Math.round(Math.max(y / 800, 0) * 1e2) / 1e2,
        }
    }

    function move(slotId, newPosition) {
        const slot = loadedLayout.layoutTemplateSlots.find(slot => slot.id == slotId)
        const relative = toRelative(newPosition.left, newPosition.top)
        slot.x = relative.x
        slot.y = relative.y
    }

    function resize(slotId, newPosition, newSize) {
        const slot = loadedLayout.layoutTemplateSlots.find(slot => slot.id == slotId)
        const relativePosition = toRelative(newPosition.left, newPosition.top)
        const relativeSize = toRelative(newSize.width, newSize.height)
        slot.x = relativePosition.x
        slot.y = relativePosition.y
        slot.width = relativeSize.x
        slot.height = relativeSize.y
    }

    loadLayout('pip_layout')
</script>
</html>